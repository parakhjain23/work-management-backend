generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id           Int          @id @default(autoincrement())
  orgId        Int          @map("org_id")
  keyName      String       @map("key_name") @db.VarChar(255)
  externalTool String?      @map("external_tool") @db.VarChar(100)
  name         String       @db.VarChar(255)
  createdBy    Int?         @map("created_by")
  updatedBy    Int?         @map("updated_by")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  workItems    WorkItem[]
  followers    CategoryFollower[]
  customFieldMetaData CustomFieldMetaData[]

  @@unique([orgId, keyName])
  @@map("categories")
}

model WorkItem {
  id          Int          @id @default(autoincrement())
  orgId       Int          @map("org_id")
  externalId  String?      @map("external_id") @db.VarChar(255)
  categoryId  Int?         @map("category_id")
  title       String       @db.VarChar(500)
  description String?      @db.Text
  status      WorkItemStatus @default(CAPTURED)
  priority    WorkItemPriority?
  assigneeId  Int?         @map("assignee_id")
  createdBy   Int?         @map("created_by")
  updatedBy   Int?         @map("updated_by")
  startDate   DateTime?    @map("start_date") @db.Date
  dueDate     DateTime?    @map("due_date") @db.Date
  parentId    Int?         @map("parent_id")
  rootParentId Int?        @map("root_parent_id")
  docId       String?      @map("doc_id") @db.VarChar(255)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  category    Category?    @relation(fields: [categoryId], references: [id])
  parent      WorkItem?    @relation("WorkItemHierarchy", fields: [parentId], references: [id])
  children    WorkItem[]   @relation("WorkItemHierarchy")
  rootParent  WorkItem?    @relation("WorkItemRootHierarchy", fields: [rootParentId], references: [id])
  rootChildren WorkItem[]  @relation("WorkItemRootHierarchy")
  logs        WorkItemLog[]
  customFieldValues CustomFieldValue[]

  @@index([orgId], name: "idx_work_items_org")
  @@index([categoryId], name: "idx_work_items_category")
  @@index([status], name: "idx_work_items_status")
  @@index([assigneeId], name: "idx_work_items_assignee")
  @@index([parentId], name: "idx_work_items_parent")
  @@index([rootParentId], name: "idx_work_items_root_parent")
  @@index([docId], name: "idx_work_items_doc")
  @@map("work_items")
}

model WorkItemLog {
  id         Int         @id @default(autoincrement())
  workItemId Int         @map("work_item_id")
  logType    LogType     @map("log_type")
  oldValue   String?     @map("old_value") @db.Text
  newValue   String?     @map("new_value") @db.Text
  message    String?     @db.Text
  createdAt  DateTime    @default(now()) @map("created_at")

  workItem   WorkItem    @relation(fields: [workItemId], references: [id])

  @@map("work_item_logs")
}

model CategoryFollower {
  id         Int         @id @default(autoincrement())
  categoryId Int         @map("category_id")
  userId     Int         @map("user_id")
  followedAt DateTime    @default(now()) @map("followed_at")

  category   Category    @relation(fields: [categoryId], references: [id])

  @@unique([categoryId, userId])
  @@map("category_followers")
}

model CustomFieldMetaData {
  id          Int         @id @default(autoincrement())
  orgId       Int         @map("org_id")
  categoryId  Int         @map("category_id")
  name        String      @db.VarChar(255)
  keyName     String      @map("key_name") @db.VarChar(255)
  dataType    DataType    @map("data_type")
  enums       String?     @db.Text
  description String?     @db.Text
  meta        Json?
  createdBy   Int?        @map("created_by")
  updatedBy   Int?        @map("updated_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  category    Category    @relation(fields: [categoryId], references: [id])
  customFieldValues CustomFieldValue[]

  @@unique([orgId, categoryId, keyName])
  @@map("custom_field_meta_data")
}

model CustomFieldValue {
  id                    Int         @id @default(autoincrement())
  workItemId            Int         @map("work_item_id")
  customFieldMetaDataId Int         @map("custom_field_meta_data_id")
  valueNumber           Decimal?    @map("value_number") @db.Decimal(15, 4)
  valueText             String?     @map("value_text") @db.Text
  valueBoolean          Boolean?    @map("value_boolean")
  valueJson             Json?       @map("value_json")
  calculatedBy          CalculatedBy @default(ai) @map("calculated_by")
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  workItem              WorkItem    @relation(fields: [workItemId], references: [id])
  customFieldMetaData   CustomFieldMetaData @relation(fields: [customFieldMetaDataId], references: [id])

  @@unique([workItemId, customFieldMetaDataId])
  @@index([customFieldMetaDataId], name: "idx_custom_field_values_field")
  @@index([workItemId], name: "idx_custom_field_values_work_item")
  @@map("custom_field_values")
}

enum WorkItemStatus {
  CAPTURED
  CLARIFYING
  THINKING
  DECIDED
  IN_PROGRESS
  IN_REVIEW
  CLOSED
  ARCHIVED
}

enum WorkItemPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum LogType {
  status_change
  comment
  sync
  ai_analysis
  field_update
}

enum DataType {
  number
  text
  boolean
  json
}

enum CalculatedBy {
  ai
  user
  system
}

model SystemPrompt {
  id              Int         @id @default(autoincrement())
  orgId           Int         @map("org_id")
  
  name            String      @db.VarChar(255)
  eventType       String?     @map("event_type") @db.VarChar(100)
  conditionCode   String?     @map("condition_code") @db.Text
  promptTemplate  String      @map("prompt_template") @db.Text
  
  createdBy       Int?        @map("created_by")
  updatedBy       Int?        @map("updated_by")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @default(now()) @updatedAt @map("updated_at")

  @@unique([orgId, name])
  @@index([orgId], name: "idx_system_prompts_org")
  @@index([eventType], name: "idx_system_prompts_event_type")
  @@index([orgId, eventType], name: "idx_system_prompts_org_event")
  @@map("system_prompts")
}
